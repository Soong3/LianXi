<!doctype html>
<html lang="zh-CN">
 <head>
  <meta charset="utf-8">
  <link rel="canonical" href="https://blog.csdn.net/jinbaotong/article/details/144971804">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="report" content="{&quot;pid&quot;: &quot;blog&quot;, &quot;spm&quot;:&quot;1001.2101&quot;}">
  <meta name="referrer" content="always">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <link rel="alternate" media="handheld" href="#">
  <meta name="shenma-site-verification" content="5a59773ab8077d4a62bf469ab966a63b_1497598848">
  <meta name="applicable-device" content="pc">
  <link href="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/static/logo/favicon32.ico" rel="shortcut icon" type="image/x-icon">
  <title>基于DPDK的用户态协议栈（1）DPKD简介及环境配置-CSDN博客</title>
  <meta name="keywords" content="dpkd">
  <meta name="csdn-baidu-search" content="{&quot;autorun&quot;:true,&quot;install&quot;:true,&quot;keyword&quot;:&quot;dpkd&quot;}">
  <meta name="description" content="文章浏览阅读962次，点赞14次，收藏15次。DPDK（Data Plane Development Kit）是一个由Intel主导开发的，主要用于高性能数据包处理。绕过了Linux网络协议栈，直接在用户空间中对数据包处理过程，以减少数据包处理的延迟和提高吞吐量。Linux内核将DPDK应用程序看作是一个普通的用户态进程，包括它的编译、连接和加载方式和普通程序没有什么两样。DPDK程序启动后只能有一个主线程，然后创建一些子线程并绑定到指定CPU核心上运行。_dpkd">
  <link rel="stylesheet" type="text/css" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/css/detail_enter-2569705caf.min.css">
  <link rel="stylesheet" type="text/css" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/themesSkin/skin-1024/skin-1024-ecd36efea2.min.css">
  <script src="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/lib/jquery/1.12.4/jquery.min.js" type="text/javascript"></script>
  <meta name="toolbar" content="{&quot;type&quot;:&quot;0&quot;,&quot;fixModel&quot;:&quot;1&quot;}">
  <link rel="stylesheet" type="text/css" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/public/sandalstrap/1.4/css/sandalstrap.min.css">
  <style>
        .MathJax, .MathJax_Message, .MathJax_Preview{
            display: none
        }
    </style>
 </head>
 <body class="nodata  " style="">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/css/blog_code-01256533b5.min.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/chart-3456820cac.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/lib/swiper/6.0.4/css/swiper.css"><div class="main_father clearfix d-flex justify-content-center mainfather-concision" style="height:100%;"><div class="container clearfix container-concision" id="mainBox">
    <main>
     <div class="blog-content-box"><div class="article-header-box"><div class="article-header"><div class="article-title-box">
         <h1 class="title-article" id="articleContentId">基于DPDK的用户态协议栈（1）DPKD简介及环境配置</h1></div><div class="article-info-box"><div class="article-bar-top-box"><div class="article-bar-top"><img class="article-type-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/original.png" alt=""><div class="bar-content"> <a class="follow-nickName " href="https://blog.csdn.net/jinbaotong" target="_blank" rel="noopener" title="jinbaotong">jinbaotong</a> <img class="article-time-img article-heard-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/newUpTime2.png" alt=""> <span class="time">已于&nbsp;2025-01-07 13:50:50&nbsp;修改</span>
            <div class="read-count-box"><img class="article-read-img article-heard-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/articleReadEyes2.png" alt=""> <span class="read-count">阅读量962</span> <a id="blog_detail_zk_collection" class="un-collection" data-report-click="{&quot;mod&quot;:&quot;popu_823&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4232&quot;,&quot;ab&quot;:&quot;new&quot;}"> <img class="article-collect-img article-heard-img un-collect-status isdefault" style="display:inline-block" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/tobarCollect2.png" alt=""> <img class="article-collect-img article-heard-img collect-status isactive" style="display:none" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/tobarCollectionActive2.png" alt=""> <span class="name">收藏</span> <span class="get-collection"> 15 </span> </a>
             <div class="read-count-box is-like" data-type="top"><img class="article-read-img article-heard-img" style="display:none" id="is-like-imgactive-new" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/newHeart2023Active.png" alt=""> <img class="article-read-img article-heard-img" style="display:block" id="is-like-img-new" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/newHeart2023Black.png" alt=""> <span class="read-count" id="blog-digg-num">点赞数 14 </span></div></div></div></div><div class="operating"><a class="href-article-edit slide-toggle">CC 4.0 BY-SA版权</a></div></div><div class="blog-tags-box"><div class="tags-box artic-tag-box"><span class="label">文章标签：</span> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;网络&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;网络\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;网络&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;网络\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E7%BD%91%E7%BB%9C&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">网络</a></div></div><div class="up-time">
          <span>于&nbsp;2025-01-06 21:48:59&nbsp;首次发布</span></div><div class="slide-content-box"><div class="article-copyright"><div class="creativecommons">
            版权声明：本文为博主原创文章，遵循<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener"> CC 4.0 BY-SA </a>版权协议，转载请附上原文出处链接和本声明。</div><div class="article-source-link">
            本文链接：<a href="https://blog.csdn.net/jinbaotong/article/details/144971804" target="_blank">https://blog.csdn.net/jinbaotong/article/details/144971804</a></div></div></div></div></div></div><div id="blogHuaweiyunAdvert" class=""></div>
      <article class="baidu_pl"><div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-10bf609291.css"><div id="content_views" class="htmledit_views atom-one-dark">
         <h2>一、DPDK</h2>
         <h3>1.1 DPDK简介</h3>
         <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DPDK（Data&nbsp;Plane&nbsp;Development Kit）是一个由Intel主导开发的<a href="https://so.csdn.net/so/search?q=%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE&amp;spm=1001.2101.3001.7020" title="开源项目">开源项目</a>，主要用于高性能数据包处理。绕过了Linux网络协议栈，直接在用户空间中对数据包处理过程，以减少数据包处理的延迟和提高吞吐量。Linux内核将DPDK应用程序看作是一个普通的用户态进程，包括它的编译、连接和加载方式和普通程序没有什么两样。DPDK程序启动后只能有一个主线程，然后创建一些子线程并绑定到指定CPU核心上运行。</p>
         <h3>1.2 DPDK工作原理</h3>
         <h3><img alt="" height="346" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/e45ec666b0ae4e4a8688f0e20000d652.png" width="1200"></h3>
         <p>&nbsp; &nbsp; &nbsp; &nbsp; 这是网络数据的传输流程图。</p>
         <ul>
          <li>网卡：把物理层的模拟信号与数据链路层的数字信号互相转换。网卡接收到数据，产生中断通知cpu，cpu使用驱动将网卡中的缓存信息读取到内存中，后续各协议栈、应用层因此解析读取此信息。</li><li>网卡驱动：负责网卡正常工作。为数据提供一个sk_buff地址，将这个地址传给协议栈。主要分为两部分1、Nic框架 2、根据Nic框架下实现自己网卡驱动。</li><li>协议栈：进行以太网、ip协议解析、udp解析、tcp解析。等待用户态的读取。</li><li>posix api：提供用户态和内核态的交互</li><li>app：用户态读取数据</li>
         </ul>
         <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DPDK模式下，DPDK接管网卡，硬件中断后放弃中断流程，直接从网卡的缓存中提取数据，绕过了操作系统内核，总而减少了数据包处理的延迟。</p>
         <p><img alt="" height="722" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/e6f6565b1be2431db66fbf84ef7826bc.png" width="1200"></p>
         <p>&nbsp; &nbsp; &nbsp; &nbsp; 在DPDK中UIO和VFIO是网络数据处理中两种重要的技术。UIO是一种运行在用户空间的I/O技术，它将驱动的很少一部分运行在内核空间，在用户空间实现驱动的绝大多数功能。DPDK利用UIO技术，将网卡驱动从内核空间转移到用户空间，从而减少了报文在用户空间和应用空间的多次拷贝，提高了数据包的处理效率。</p>
         <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在虚拟化环境中，VFIO允许虚拟机直接访问物理硬件资源（如网卡），而无需通过宿主机的内核或虚拟化层进行中转。提高了虚拟化环境中的设备直通性能。增强了设备隔离和安全性，降低了虚拟化环境中的安全风险。UIO更适用于需要高性能数据包处理的场景，而VFIO则更适用于虚拟化环境中的设备直通场景。</p>
         <p>&nbsp; &nbsp; &nbsp; &nbsp; DPDK的KNI技术允许用户空间应用程序直接访问内核网络协议栈，将用户空间和内核空间之间的数据传输最小化，可以更灵活地控制和处理网络数据包，从而降低网络处理的延迟和开销。</p>
         <h3>1.3 DPDK的搭建环境</h3>
         <h4>1.3.1 多队列网卡</h4>
         <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;多队列网卡可以将网络流量分发到多个硬件队列中进行并行处理，充分利用多核处理器的并行处理能力，可以使每个核心都能独立处理网络流量，从而减轻单个队列的负载压力,提高整体系统性能。这对于高速网络应用来说至关重要。</p>
         <p>&nbsp; &nbsp; &nbsp; &nbsp; 首先查看使用的网卡是否是多队列网卡。</p>
         <pre class="set-code-show"><code>cat /proc/interrupts | grep 网卡名</code></pre>
         <p><img alt="" height="140" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/7fd56623c48e41f5983a2a7258a2715c.png" width="665"></p>
         <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以看到eht2不是多队列网卡，eth1是多队列网卡。</p>
         <p>找到该虚拟机中的vmx文件。更改以下两句代码：</p>
         <pre class="set-code-show"><code>ethernet2.virtualDev = “vmxnet3”
ethernet2.wakeOnPcktRcv = “TRUE”
</code></pre>
         <p>可将所用网卡设置成多队列网卡。</p>
         <p>注意：在虚拟机关闭的状态下进行文件更改。</p>
         <h4>1.3.2 hugepage设置</h4>
         <p>&nbsp; &nbsp; &nbsp; &nbsp; hugepage，即大页内存管理方式，是相对传统4KB小页而言的。Hugepage允许将连续的几个内存页合并成一个更大的页，常见的大小有2MB、4MB、16MB等，甚至更大如1GB。它是为了管理大内存（8GB以上）而设计的一种更为高效的内存管理方式。通过配置数据库系统使用巨页，可以加速数据访问和处理，提升系统的吞吐量和响应速度。</p>
         <pre class="set-code-show"><code>sudo vim /etc/default/grub</code></pre>
         <p><img alt="" height="33" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/ccb255f72af94ebc9c2c3de6786654b3.png" width="753"></p>
         <p>如图添加代码。</p>
         <h4>1.3.3 DPDK内部环境</h4>
         <p>&nbsp; &nbsp; &nbsp; &nbsp; 1、选择DPDK的环境：</p>
         <pre class="set-code-show"><code>./usertools/dpdk-setup.sh
//路径为相应版本的dpdk文件</code></pre>
         <p>本文选择的是[39]x86_64-native-linux-gcc。（只需配置一次）</p>
         <p>&nbsp; &nbsp; &nbsp; &nbsp; 2、环境变量</p>
         <p>导出<code>RTE_SDK</code>和<code>RTE_TARGET两个环境变量。（每次都需要重新配置）</code></p>
         <pre class="set-code-show"><code>RTE_SDK=/home/.../dpdk-stable-19.08.2/
RTE_TARGET=x86_64-native-linux-gcc</code></pre>
         <p>&nbsp; &nbsp; &nbsp; &nbsp; 3、linux环境</p>
         <p><img alt="" height="205" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/6730c01902ea4fcf8787b8f669d5796a.png" width="470"></p>
         <p>设置其中43、44、45、46、47、49。（每次都要重新配置）</p>
         <p><a href="https://github.com/0voice" title="https://github.com/0voice">https://github.com/0voice</a></p></div></div>
      </article></div>
    </main></div><div class="recommend-right align-items-stretch clearfix" id="rightAside" data-type="recommend"></div></div>
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blog_editor_html/release1.6.12/ckeditor/plugins/chart/chart.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/lib/cboxEditor/1.1.6/embed-editor.min.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blog_editor_html/release1.6.12/ckeditor/plugins/codesnippet/lib/highlight/styles/atom-one-dark.css">
  <script>
    $(".MathJax").remove();
    if ($('div.markdown_views pre.prettyprint code.hljs').length > 0) {
      $('div.markdown_views')[0].className = 'markdown_views';
    }
  </script>
  <script type="text/javascript" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blog_mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      "HTML-CSS": {
        linebreaks: { automatic: true, width: "94%container" },
        imageFont: null
      },
      tex2jax: {
      preview: "none",
      ignoreClass:"title-article"
      },
      mml2jax: {
      preview: 'none'
      }
    });
  </script>
 </body> 
</html>