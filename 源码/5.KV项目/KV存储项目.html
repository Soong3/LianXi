<!doctype html>
<html lang="zh-CN">
 <head>
  <meta charset="utf-8">
  <link rel="canonical" href="https://blog.csdn.net/vision_wei_/article/details/146214660">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="report" content="{&quot;pid&quot;: &quot;blog&quot;, &quot;spm&quot;:&quot;1001.2101&quot;}">
  <meta name="referrer" content="always">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <link rel="alternate" media="handheld" href="#">
  <meta name="shenma-site-verification" content="5a59773ab8077d4a62bf469ab966a63b_1497598848">
  <meta name="applicable-device" content="pc">
  <link href="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/static/logo/favicon32.ico" rel="shortcut icon" type="image/x-icon">
  <title>KV存储项目_kv 存储-CSDN博客</title>
  <meta name="keywords" content="kv 存储">
  <meta name="csdn-baidu-search" content="{&quot;autorun&quot;:true,&quot;install&quot;:true,&quot;keyword&quot;:&quot;kv 存储&quot;}">
  <meta name="description" content="文章浏览阅读955次，点赞22次，收藏25次。网络编程实战项目，基于c++的KV存储实现_kv 存储">
  <link rel="stylesheet" type="text/css" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/css/detail_enter-2569705caf.min.css">
  <link rel="stylesheet" type="text/css" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/themesSkin/skin-whitemove/skin-whitemove-2af9149bdc.min.css">
  <script src="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/lib/jquery/1.12.4/jquery.min.js" type="text/javascript"></script>
  <meta name="toolbar" content="{&quot;type&quot;:&quot;0&quot;,&quot;fixModel&quot;:&quot;1&quot;}">
  <link rel="stylesheet" type="text/css" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/public/sandalstrap/1.4/css/sandalstrap.min.css">
  <style>
        .MathJax, .MathJax_Message, .MathJax_Preview{
            display: none
        }
    </style>
 </head>
 <body class="nodata  " style="">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/css/blog_code-01256533b5.min.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/chart-3456820cac.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/lib/swiper/6.0.4/css/swiper.css"><div class="main_father clearfix d-flex justify-content-center mainfather-concision" style="height:100%;"><div class="container clearfix container-concision" id="mainBox">
    <main>
     <div class="blog-content-box"><div class="article-header-box"><div class="article-header"><div class="article-title-box">
         <h1 class="title-article" id="articleContentId">KV存储项目</h1></div><div class="article-info-box"><div class="article-bar-top-box"><div class="article-bar-top"><img class="article-type-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/original.png" alt=""><div class="bar-content"> <a class="follow-nickName " href="https://blog.csdn.net/vision_wei_" target="_blank" rel="noopener" title="vision_wei_">vision_wei_</a> <img class="article-time-img article-heard-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/newUpTime2.png" alt=""> <span class="time">已于&nbsp;2025-07-29 16:50:37&nbsp;修改</span>
            <div class="read-count-box"><img class="article-read-img article-heard-img" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/articleReadEyes2.png" alt=""> <span class="read-count">阅读量955</span> <a id="blog_detail_zk_collection" class="un-collection" data-report-click="{&quot;mod&quot;:&quot;popu_823&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4232&quot;,&quot;ab&quot;:&quot;new&quot;}"> <img class="article-collect-img article-heard-img un-collect-status isdefault" style="display:inline-block" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/tobarCollect2.png" alt=""> <img class="article-collect-img article-heard-img collect-status isactive" style="display:none" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/tobarCollectionActive2.png" alt=""> <span class="name">收藏</span> <span class="get-collection"> 25 </span> </a>
             <div class="read-count-box is-like" data-type="top"><img class="article-read-img article-heard-img" style="display:none" id="is-like-imgactive-new" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/newHeart2023Active.png" alt=""> <img class="article-read-img article-heard-img" style="display:block" id="is-like-img-new" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/pc/img/newHeart2023Black.png" alt=""> <span class="read-count" id="blog-digg-num">点赞数 22 </span></div></div></div></div><div class="operating"><a class="href-article-edit slide-toggle">CC 4.0 BY-SA版权</a></div></div><div class="blog-tags-box"><div class="tags-box artic-tag-box"><span class="label">分类专栏：</span> <a class="tag-link" href="https://blog.csdn.net/vision_wei_/category_13009530.html" target="_blank" rel="noopener">项目</a> <span class="label">文章标签：</span> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;网络&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;网络\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;网络&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;网络\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E7%BD%91%E7%BB%9C&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">网络</a> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;c++&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;c++\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;c++&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;c++\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=c%2B%2B&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">c++</a> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;sql&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;sql\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;sql&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;sql\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=sql&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">sql</a> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;后端&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;后端\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;后端&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;后端\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E5%90%8E%E7%AB%AF&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">后端</a> <a rel="nofollow" data-report-query="spm=1001.2101.3001.4223" data-report-click="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;分布式&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;分布式\&quot;}&quot;}" data-report-view="{&quot;mod&quot;:&quot;popu_626&quot;,&quot;spm&quot;:&quot;1001.2101.3001.4223&quot;,&quot;strategy&quot;:&quot;分布式&quot;,&quot;ab&quot;:&quot;new&quot;,&quot;extra&quot;:&quot;{\&quot;searchword\&quot;:\&quot;分布式\&quot;}&quot;}" class="tag-link" href="https://so.csdn.net/so/search/s.do?q=%E5%88%86%E5%B8%83%E5%BC%8F&amp;t=all&amp;o=vip&amp;s=&amp;l=&amp;f=&amp;viparticle=&amp;from_tracking_code=tag_word&amp;from_code=app_blog_art" target="_blank">分布式</a></div></div><div class="up-time">
          <span>于&nbsp;2025-07-20 14:23:18&nbsp;首次发布</span></div><div class="slide-content-box"><div class="article-copyright"><div class="creativecommons">
            版权声明：本文为博主原创文章，遵循<a href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener"> CC 4.0 BY-SA </a>版权协议，转载请附上原文出处链接和本声明。</div><div class="article-source-link">
            本文链接：<a href="https://blog.csdn.net/vision_wei_/article/details/146214660" target="_blank">https://blog.csdn.net/vision_wei_/article/details/146214660</a></div></div></div></div></div></div><div id="blogHuaweiyunAdvert" class=""></div>
      <article class="baidu_pl"><div id="article_content" class="article_content clearfix">
        <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/kdoc_html_views-1a98987dfd.css">
        <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/ck_htmledit_views-10bf609291.css"><div id="content_views" class="markdown_views prism-atom-one-light">
         <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
         </svg>
         <p></p>
         <div class="toc">
          <h4>文章目录</h4>
          <ul>
           <li><a href="#kv_4">一、kv存储总体架构</a></li><li>
            <ul>
             <li><a href="#1__5">1. 项目简介</a></li><li><a href="#2__17">2. 总体架构设计</a></li><li><a href="#3__32">3. 用到的技术栈</a></li><li>
              <ul>
               <li><a href="#_49">编译指令</a></li>
              </ul></li>
            </ul></li><li><a href="#_72">二、网络层设计</a></li><li>
            <ul>
             <li><a href="#0__73">0. 网络层设计介绍</a></li><li>
              <ul>
               <li><a href="#_81">不直接使用系统调用的好处</a></li>
              </ul></li><li><a href="#1_Reactor_90">1. Reactor模型</a></li><li><a href="#2_Proactor_381">2. Proactor模型</a></li><li><a href="#3_NtyCo_394">3. NtyCo协程实现网络层</a></li><li>
              <ul>
               <li><a href="#1_kvstorehenum_397">1. kvstore.h里添加enum：</a></li><li><a href="#2_kvstorec_409">2. kvstore.c里实现</a></li><li><a href="#_587">实现结果</a></li><li><a href="#3_list_591">3. 实现list数组用来储存数据</a></li><li><a href="#4_kvs_arrayc_826">4. 添加kvs_array.c,实现功能：</a></li><li><a href="#5_kvstoreh_1074">5. kvstore.h添加定义</a></li><li><a href="#_1208">编译命令</a></li><li><a href="#_1211">测试结果</a></li>
              </ul></li><li><a href="#BUG_1221">BUG整理</a></li>
            </ul></li><li><a href="#_1225">三、引擎层设计</a></li><li>
            <ul>
             <li><a href="#0_KV_1226">0. KV引擎层介绍</a></li><li><a href="#1_kvs_array_1241">1. kvs_array</a></li><li>
              <ul>
               <li><a href="#_1242">数据结构设计</a></li><li><a href="#_1256">功能函数设计</a></li>
              </ul></li><li><a href="#2_kvs_rbtree_1317">2. kvs_rbtree</a></li><li>
              <ul>
               <li><a href="#_1318">数据结构设计</a></li><li><a href="#_1336">功能函数设计</a></li>
              </ul></li><li><a href="#3_kvs_hash_1376">3. kvs_hash</a></li><li>
              <ul>
               <li><a href="#_1377">数据结构设计</a></li><li><a href="#_1397">功能函数设计</a></li>
              </ul></li><li><a href="#_1439">测试用例实现</a></li><li>
              <ul>
               <li><a href="#testcasec_1446">测试用例编写testcase.c</a></li><li><a href="#BUG_1464">BUG整理</a></li>
              </ul></li>
            </ul></li><li><a href="#KV_1474">四、KV存储性能测试</a></li><li>
            <ul>
             <li><a href="#kvhashskiptablekvstore_1481">kv引擎hash、自己实现skiptable融入kvstore</a></li><li><a href="#_1488">第三方语言支持</a></li><li><a href="#_1496">十个面试题</a></li>
            </ul></li>
          </ul></div>
         <p></p>
         <hr>
         <h2><a id="kv_4"></a>一、kv存储总体架构</h2>
         <h3><a id="1__5"></a>1. 项目简介</h3>
         <p>KVStore 是一种简单的数据存储]模型，它以键（Key）和值（Value）的形式来存储和检索数据。就像是一个字典，通过一个特定的 “键” 来查找对应的 “值”。<br> 意义： <em>1.<em>业务简单，不需要用到复杂的功能；<br> <em>2.<em>可以将性能做到极致，对比</em></em></em>Redis</em>**会更好； <a href="https://blog.csdn.net/weixin_46258766/article/details/136228729">Redis面试题</a></p>
         <blockquote>
          <p>KV存储系统对<em>非结构化和半结构化数据进行高效存储</em>，提供很好的解决方案</p>
          <blockquote>
           <ol>
            <li>KV存储系统具有灵活的数据模型，数据表示为Key, Value对形式，为任意数据类型，且长度不定；</li><li>访存接口非常简单，向外提供Put、Get、Scan等简单的接口进行数据读写；</li><li>具备高可扩展性，数据基于Key进行划分和索引，无需维护额外的元数据-</li>
           </ol>
          </blockquote>
         </blockquote>
         <hr>
         <h3><a id="2__17"></a>2. 总体架构设计</h3>
         <p>​ 本项目采用C语言，默认键值对都是<code>char *</code>类型。首先我们希望在客户端发送相应指令到服务端，服务端收到合法指令后执行相应的操作并返回<code>OK</code>，<code>EXIST</code>和<code>NO EXIST</code>等给客户端.</p>
         <ul>
          <li><p>项目架构设计<br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/img_convert/0c7134c7690c5653fb7b0c53b3bdfeae.png" alt="image.png"></p> <pre class="set-code-show"><code class="prism language-c">网络层：设计了三种网络方案，可以通过宏定义进行切换；
协议层：基本参考了redis的方案；
核心层：对客户端的数据进行解析，并调用不同的处理函数；
接口层：将相应数据结构的接口进行封装，并对内存管理模块进行独立设计；
引擎层：目前实现了四种存储引擎，都具备增删改查等操作。
</code></pre></li><li><p>协议层对应的数据结构及命令<br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/106934d5aaf04739bcb22eb1a3572395.png" alt="在这里插入图片描述"></p></li>
         </ul>
         <h3><a id="3__32"></a>3. 用到的技术栈</h3>
         <pre class="set-code-show"><code class="prism language-c"><span class="token operator">+</span> 网络框架
  <span class="token number">1.</span> 协程NytCo
  <span class="token number">2.</span> io_uring（异步IO）
  <span class="token number">3.</span> reactor网络模型
<span class="token operator">+</span> 数据结构
  <span class="token number">1.</span> 红黑树rbtree
  <span class="token number">2.</span> 跳表skiptable
  <span class="token number">3.</span> 哈希表hash
<span class="token operator">+</span> Makefile
<span class="token operator">+</span> 内存池
<span class="token operator">+</span> 线程池
<span class="token operator">+</span> 日志库
</code></pre>
         <hr>
         <h4><a id="_49"></a>编译指令</h4>
         <p>mkdir 9.1-kvstore | rm -rf name | mv dhash.c kvs_hash.c<br> make | make clean | cp sample/hook_tcpserver.c ./</p>
         <pre class="set-code-show"><code class="prism language-c"><span class="token comment">// io_uring </span>
gcc <span class="token operator">-</span>o kvstore kvstore<span class="token punctuation">.</span>c proactor<span class="token punctuation">.</span>c <span class="token operator">-</span>luring
<span class="token comment">// ntyco</span>
gcc <span class="token operator">-</span>o kvstore kvstore<span class="token punctuation">.</span>c  ntyco<span class="token punctuation">.</span>c <span class="token operator">-</span>I <span class="token punctuation">.</span><span class="token operator">/</span>NtyCo<span class="token operator">/</span>core<span class="token operator">/</span> <span class="token operator">-</span>L  <span class="token punctuation">.</span><span class="token operator">/</span>NtyCo<span class="token operator">/</span> <span class="token operator">-</span>lntyco
<span class="token comment">// reactor</span>
gcc <span class="token operator">-</span>o kvstore kvstore<span class="token punctuation">.</span>c reactor<span class="token punctuation">.</span>c  <span class="token operator">-</span>I <span class="token punctuation">.</span><span class="token operator">/</span>NtyCo<span class="token operator">/</span>core<span class="token operator">/</span> <span class="token operator">-</span>L  <span class="token punctuation">.</span><span class="token operator">/</span>NtyCo<span class="token operator">/</span> <span class="token operator">-</span>lntyco

gcc <span class="token operator">-</span>o kvstore kvstore<span class="token punctuation">.</span>c reactor<span class="token punctuation">.</span>c  proactor<span class="token punctuation">.</span>c ntyco<span class="token punctuation">.</span>c <span class="token operator">-</span>I <span class="token punctuation">.</span><span class="token operator">/</span>NtyCo<span class="token operator">/</span>core<span class="token operator">/</span> <span class="token operator">-</span>L  <span class="token punctuation">.</span><span class="token operator">/</span>NtyCo<span class="token operator">/</span> <span class="token operator">-</span>lntyco
gcc <span class="token operator">-</span>o kvstore kvstore<span class="token punctuation">.</span>c ntyco<span class="token punctuation">.</span>c proactor<span class="token punctuation">.</span>c kvs_array<span class="token punctuation">.</span>c <span class="token operator">-</span>I <span class="token punctuation">.</span><span class="token operator">/</span>NtyCo<span class="token operator">/</span>core<span class="token operator">/</span> <span class="token operator">-</span>L  <span class="token punctuation">.</span><span class="token operator">/</span>NtyCo<span class="token operator">/</span> <span class="token operator">-</span>lntyco <span class="token operator">-</span>luring

<span class="token comment">//执行    </span>
<span class="token punctuation">.</span><span class="token operator">/</span>kvstore <span class="token number">2000</span>
</code></pre>
         <p><a href="https://github.com/wangbojing/NtyCo">NtyCo 问题解决</a></p>
         <hr>
         <h2><a id="_72"></a>二、网络层设计</h2>
         <h3><a id="0__73"></a>0. 网络层设计介绍</h3>
         <p>​kv存储项目在网络层这方面并未选择第三方库，而是分别基于<code>epoll</code>来实现了<code>reactor</code>网络模型，基于<code>ntyco</code>协程库来实现网络message收发，基于<code>io_uring</code>来实现<code>proactor</code>网络模型。<br> <em><strong>reactor | proactor | 协程</strong> 这三种实现方式网络层，针对不同场景可以随时切换</em><br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/fef5fc75302f4b40a5c6f00e614e7216.png" alt="请添加图片描述"><br> <strong>设计效果：</strong><br> <em>将网络封装好只暴露出一个接口，在用户层主程序调用封装好的网络接口</em><br> 在主程序中定义一个kvs协议，首先简单设置协议发送服务器接收到的数据。设计好的网络接口应该有两个参数，kvs协议和监听端口号。直接将原网络程序的主函数修改成外部接口即可</p>
         <h4><a id="_81"></a>不直接使用系统调用的好处</h4>
         <p>自己封装一层，后面跨平台改代码api, 只需要改变对应函数接口</p>
         <pre class="set-code-show"><code class="prism language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>kvs_malloc<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">//  &lt;==封装一层</span>
  	<span class="token keyword">return</span> <span class="token operator">*</span><span class="token operator">*</span>malloc<span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//  &lt;==系统函数</span>
<span class="token punctuation">}</span>
</code></pre>
         <hr>
         <h3><a id="1_Reactor_90"></a>1. Reactor模型</h3>
         <p>1.recv_cb里面添加了kvs_request,send_cb里添加了kvs_response（响应）<br> 2.server从client获取kv存储请求（kvs_reques）<br> 3.返回处理结果（kvs_response）</p>
         <p>主程序kvstore.h <a href="https://blog.csdn.net/jinbaotong/article/details/145352968?spm=1001.2014.3001.5502">基于reactor和协程网络层分析</a></p>
         <pre class="set-code-show"><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"server.h"</span></span>
 
<span class="token comment">// 定义最大连接数：支持最多 1024 个连接</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CONNECTION_SIZE</span>         <span class="token expression"><span class="token number">1024</span> </span><span class="token comment">// 1024 * 1024</span></span>
 
<span class="token comment">// 定义最大监听端口数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_PORTS</span>               <span class="token expression"><span class="token number">20</span></span></span>
 
<span class="token comment">// 计算两个时间点之间的毫秒差</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">TIME_SUB_MS</span><span class="token expression"><span class="token punctuation">(</span>tv1<span class="token punctuation">,</span> tv2<span class="token punctuation">)</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span>tv1<span class="token punctuation">.</span>tv_sec <span class="token operator">-</span> tv2<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">+</span> <span class="token punctuation">(</span>tv1<span class="token punctuation">.</span>tv_usec <span class="token operator">-</span> tv2<span class="token punctuation">.</span>tv_usec<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span></span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_KVSTORE</span></span>
 
<span class="token comment">// 定义消息处理函数类型，用于处理 KV 存储请求</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>msg_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">static</span> msg_handler kvs_handler<span class="token punctuation">;</span>
 
<span class="token comment">// KV 存储请求处理函数：接收客户端请求数据，并调用回调函数处理请求</span>
<span class="token keyword">int</span> <span class="token function">kvs_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">conn</span> <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 打印接收到的数据及其长度（调试信息）</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv %d : %s\n"</span><span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>rlength<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>rbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用外部传入的处理函数，将请求数据处理后写入响应缓冲区，并返回响应数据的长度</span>
    c<span class="token operator">-&gt;</span>wlength <span class="token operator">=</span> <span class="token function">kvs_handler</span><span class="token punctuation">(</span>c<span class="token operator">-&gt;</span>rbuffer<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>rlength<span class="token punctuation">,</span> c<span class="token operator">-&gt;</span>wbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// KV 存储响应处理函数（此处尚未实现具体逻辑）</span>
<span class="token keyword">int</span> <span class="token function">kvs_response</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">conn</span> <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// TODO: 根据业务需求，实现响应数据的处理逻辑</span>
<span class="token punctuation">}</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
<span class="token comment">// 前向声明回调函数</span>
<span class="token keyword">int</span> <span class="token function">accept_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">recv_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">send_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 全局 epoll 文件描述符</span>
<span class="token keyword">int</span> epfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
<span class="token comment">// 记录时间，用于调试连接接受的时间间隔</span>
<span class="token keyword">struct</span> <span class="token class-name">timeval</span> begin<span class="token punctuation">;</span>
 
<span class="token comment">// 全局连接数组，存储所有连接的信息（每个连接对应一个文件描述符）</span>
<span class="token keyword">struct</span> <span class="token class-name">conn</span> conn_list<span class="token punctuation">[</span>CONNECTION_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token comment">// 设置或修改文件描述符的 epoll 事件注册</span>
<span class="token keyword">int</span> <span class="token function">set_event</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> event<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">// flag 非0：添加新的事件</span>
        <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> event<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
        <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">// flag 为0：修改已存在的事件</span>
        <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> ev<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>events <span class="token operator">=</span> event<span class="token punctuation">;</span>
        ev<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
        <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_MOD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 注册一个文件描述符的事件，包括初始化连接结构体和设置默认回调</span>
<span class="token keyword">int</span> <span class="token function">event_register</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 初始化连接结构体中的文件描述符</span>
    conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token comment">// 默认接收回调函数为 recv_cb</span>
    conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>r_action<span class="token punctuation">.</span>recv_callback <span class="token operator">=</span> recv_cb<span class="token punctuation">;</span>
    <span class="token comment">// 默认发送回调函数为 send_cb</span>
    conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>send_callback <span class="token operator">=</span> send_cb<span class="token punctuation">;</span>
 
    <span class="token comment">// 清空接收缓冲区，并将接收数据长度初始化为 0</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>rbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUFFER_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>rlength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 清空发送缓冲区，并将发送数据长度初始化为 0</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUFFER_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wlength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 将文件描述符添加到 epoll 中，监听指定事件（例如 EPOLLIN）</span>
    <span class="token function">set_event</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> event<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 监听套接字的接收回调函数：用于接受新连接</span>
<span class="token keyword">int</span> <span class="token function">accept_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientaddr<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>clientaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 调用 accept 接受客户端的新连接</span>
    <span class="token keyword">int</span> clientfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept finshed: %d, fd: %d\n"</span><span class="token punctuation">,</span> clientfd<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果接受失败，打印错误信息</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept errno: %d --&gt; %s\n"</span><span class="token punctuation">,</span> errno<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 对新连接进行事件注册，设置为监听 EPOLLIN（等待客户端发送数据）</span>
    <span class="token function">event_register</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 调试信息：每当 clientfd 对 1000 取余等于 0，计算并打印两次接受连接之间的时间间隔</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>clientfd <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">timeval</span> current<span class="token punctuation">;</span>
        <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>current<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> time_used <span class="token operator">=</span> <span class="token function">TIME_SUB_MS</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> begin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新上一次接受连接的时间</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>begin<span class="token punctuation">,</span> <span class="token operator">&amp;</span>current<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">timeval</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"accept finshed: %d, time_used: %d\n"</span><span class="token punctuation">,</span> clientfd<span class="token punctuation">,</span> time_used<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 客户端数据接收回调函数：处理客户端发送的数据</span>
<span class="token keyword">int</span> <span class="token function">recv_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 清空该连接的接收缓冲区</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>rbuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUFFER_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用 recv 接收数据，返回实际接收的字节数</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>rbuffer<span class="token punctuation">,</span> BUFFER_LENGTH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 客户端断开连接</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client disconnect: %d\n"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从 epoll 中删除该连接</span>
        <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 接收过程中发生错误</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"count: %d, errno: %d, %s\n"</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> errno<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 保存实际接收的字节数</span>
    conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>rlength <span class="token operator">=</span> count<span class="token punctuation">;</span>
 
    <span class="token comment">// 根据不同的编译选项，调用相应的请求处理函数</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span> </span><span class="token comment">// echo 模式：直接将接收到的数据回写到发送缓冲区（未启用）</span></span>
    conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wlength <span class="token operator">=</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>rlength<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wbuffer<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>rbuffer<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wlength<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%d]RECV: %s\n"</span><span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>rlength<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>rbuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">ENABLE_HTTP</span></span>
    <span class="token comment">// HTTP 请求处理</span>
    <span class="token function">http_request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">ENABLE_WEBSOCKET</span></span>
    <span class="token comment">// WebSocket 请求处理</span>
    <span class="token function">ws_request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">ENABLE_KVSTORE</span></span>
    <span class="token comment">// KV 存储请求处理</span>
    <span class="token function">kvs_request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
    <span class="token comment">// 修改该连接监听的事件为 EPOLLOUT，等待发送响应数据</span>
    <span class="token function">set_event</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 客户端数据发送回调函数：用于发送响应数据给客户端</span>
<span class="token keyword">int</span> <span class="token function">send_cb</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_HTTP</span></span>
    <span class="token comment">// HTTP 响应处理</span>
    <span class="token function">http_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">ENABLE_WEBSOCKET</span></span>
    <span class="token comment">// WebSocket 响应处理</span>
    <span class="token function">ws_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">ENABLE_KVSTORE</span></span>
    <span class="token comment">// KV 存储响应处理（目前 kvs_response 尚未具体实现）</span>
    <span class="token function">kvs_response</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    <span class="token comment">// 备用逻辑（根据不同状态处理发送，当前未启用）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        count <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wbuffer<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wlength<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">set_event</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">set_event</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> EPOLLOUT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wlength <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            count <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wbuffer<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wlength<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">set_event</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
    <span class="token comment">// 如果发送缓冲区中有数据，则通过 send 发送数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wlength <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        count <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wbuffer<span class="token punctuation">,</span> conn_list<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">.</span>wlength<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 发送完成后，将该连接监听的事件改回 EPOLLIN，等待下一次接收</span>
    <span class="token function">set_event</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 初始化服务器：创建监听套接字，绑定地址和端口，并开始监听连接</span>
<span class="token keyword">int</span> <span class="token function">r_init_server</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> port<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servaddr<span class="token punctuation">;</span>
    servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    <span class="token comment">// 监听所有网络接口（0.0.0.0）</span>
    servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置监听端口</span>
    servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token function">bind</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bind failed: %s\n"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 开始监听，最多允许 10 个等待连接</span>
    <span class="token function">listen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sockfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// Reactor 模式的入口函数：启动服务器，并进入事件循环处理 I/O 事件</span>
<span class="token keyword">int</span> <span class="token function">reactor_start</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> port<span class="token punctuation">,</span> msg_handler handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 保存 KV 存储处理的回调函数指针</span>
    kvs_handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"reactor_entry: %d\n"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 创建 epoll 实例</span>
    epfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化多个监听套接字，支持多端口监听（端口号连续）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_PORTS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token function">r_init_server</span><span class="token punctuation">(</span>port <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 为每个监听套接字初始化连接结构体</span>
        conn_list<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> sockfd<span class="token punctuation">;</span>
        <span class="token comment">// 监听套接字的接收回调设置为 accept_cb，用于接收新连接</span>
        conn_list<span class="token punctuation">[</span>sockfd<span class="token punctuation">]</span><span class="token punctuation">.</span>r_action<span class="token punctuation">.</span>recv_callback <span class="token operator">=</span> accept_cb<span class="token punctuation">;</span>
        <span class="token comment">// 将监听套接字添加到 epoll 中，监听 EPOLLIN 事件</span>
        <span class="token function">set_event</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> EPOLLIN<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 记录启动时的时间</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>begin<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 主事件循环，不断等待和处理 epoll 事件</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> events<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 阻塞等待事件发生，nready 表示返回的事件个数</span>
        <span class="token keyword">int</span> nready <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历所有发生的事件</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nready<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> connfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
            <span class="token comment">// 备用处理方式（未启用）：根据事件类型调用对应的回调</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                conn_list<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>r_action<span class="token punctuation">.</span><span class="token function">recv_callback</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                conn_list<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">send_callback</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span> </span>
            <span class="token comment">// 如果是可读事件，则调用对应的接收回调（可能为 accept_cb 或 recv_cb）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLIN<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                conn_list<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span>r_action<span class="token punctuation">.</span><span class="token function">recv_callback</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果是可写事件，则调用对应的发送回调</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                conn_list<span class="token punctuation">[</span>connfd<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">send_callback</span><span class="token punctuation">(</span>connfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
         <hr>
         <h3><a id="2_Proactor_381"></a>2. Proactor模型</h3>
         <p>围绕四个问题： <a href="https://blog.csdn.net/Morso/article/details/144609061?spm=1001.2014.3001.5502">Proactor网络层实现</a></p>
         <pre class="set-code-show"><code>1. liburing
2. 问题与思考
3. 事件分发
4. sqe在多线程操作下，是否需要加锁		
</code></pre>
         <hr>
         <h3><a id="3_NtyCo_394"></a>3. NtyCo协程实现网络层</h3>
         <p>初步协议实现代码 <a href="https://blog.csdn.net/weixin_45878585/article/details/146198446?spm=1001.2014.3001.5502">协程实现网络层代码分析</a></p>
         <h4><a id="1_kvstorehenum_397"></a>1. kvstore.h里添加enum：</h4>
         <pre class="set-code-show"><code class="prism language-c"><span class="token keyword">enum</span><span class="token punctuation">{<!-- --></span>
	KVS_CMD_START <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
	KVS_CMD_SET <span class="token operator">=</span> KVS_CMD_START<span class="token punctuation">,</span>
	KVS_CMD_GET<span class="token punctuation">,</span>
	KVS_CMD_DEL<span class="token punctuation">,</span>
	KVS_CMD_MOD<span class="token punctuation">,</span>
	KVS_CMD_EXIST<span class="token punctuation">,</span>
	KVS_CMD_COUNT<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
         <h4><a id="2_kvstorec_409"></a>2. kvstore.c里实现</h4>
         <pre class="set-code-show"><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kvstore.h"</span>  <span class="token comment">// 包含 KV 存储相关的头文件，其中可能定义了 KVS_CMD_* 枚举、command 字符串数组、宏 KVS_MAX_TOKENS 等</span></span>
 
<span class="token comment">/*
 * 函数: kvs_split_token
 * ----------------------
 * 用于将接收到的请求消息按照空格分割成多个 token，
 * 每个 token 通常代表命令中的一部分，例如命令名、键、值等。
 *
 * 参数:
 *   msg    - 待分割的请求消息（字符串）
 *   tokens - 字符串数组，用于存放分割后的 token 地址
 *
 * 返回:
 *   成功时返回 token 的数量；失败时返回 -1。
 *
 * 备注:
 *   使用 strtok 进行分割，该函数会修改原始字符串（将空格替换为 '\0'）。
 */</span>
<span class="token keyword">int</span> <span class="token function">kvs_split_token</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>tokens<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> tokens <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 参数检查</span>
 
    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用 strtok 从 msg 中分割第一个 token，分隔符为一个空格</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>token <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 循环分割字符串，直到没有更多的 token</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        tokens<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> token<span class="token punctuation">;</span>  <span class="token comment">// 将当前 token 的地址保存到 tokens 数组中</span>
        <span class="token comment">// 获取下一个 token，传入 NULL 让 strtok 继续之前的字符串分割</span>
        token <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 打印每个 token 的索引和值（调试信息）</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> idx<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"idx: %d, %s\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> tokens<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> idx<span class="token punctuation">;</span>  <span class="token comment">// 返回分割出的 token 数量</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
 * 函数: kvs_filter_protocol
 * ---------------------------
 * 根据分割后的 token 判断请求的命令类型，并构造对应的响应信息。
 *
 * 参数:
 *   tokens   - 存储分割后的 token 数组
 *   count    - token 的数量
 *   response - 用于保存响应数据的缓冲区
 *
 * 返回:
 *   响应数据的长度；如果参数非法则返回 -1。
 *
 * 备注:
 *   根据第一个 token（命令名称）匹配对应的命令枚举值，然后通过 switch 语句构造响应。
 *   命令字符串与枚举值的映射关系由 command 数组提供，数组定义在 kvstore.h 中。
 */</span>
<span class="token keyword">int</span> <span class="token function">kvs_filter_protocol</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>tokens<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokens <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> count <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> response <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 参数检查</span>
 
    <span class="token keyword">int</span> cmd <span class="token operator">=</span> KVS_CMD_START<span class="token punctuation">;</span>
    <span class="token comment">// 遍历所有可能的命令，从 KVS_CMD_START 到 KVS_CMD_COUNT</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>cmd <span class="token operator">=</span> KVS_CMD_START<span class="token punctuation">;</span> cmd <span class="token operator">&lt;</span> KVS_CMD_COUNT<span class="token punctuation">;</span> cmd<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 比较 tokens[0]（用户输入的命令）和预定义的命令字符串是否相同</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> command<span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 找到匹配的命令则退出循环</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据匹配到的命令类型，构造不同的响应信息</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> KVS_CMD_SET<span class="token operator">:</span>
            <span class="token comment">// 设置命令：例如 "SET key value"</span>
            ret <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"cmd SET\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KVS_CMD_GET<span class="token operator">:</span>
            <span class="token comment">// 获取命令：例如 "GET key"</span>
            ret <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"cmd GET"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KVS_CMD_DEL<span class="token operator">:</span>
            <span class="token comment">// 删除命令：例如 "DEL key"</span>
            ret <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"cmd DEL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KVS_CMD_MOD<span class="token operator">:</span>
            <span class="token comment">// 修改命令：例如 "MOD key value"</span>
            ret <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"cmd MOD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KVS_CMD_EXIST<span class="token operator">:</span>
            <span class="token comment">// 判断是否存在命令：例如 "EXIST key"</span>
            ret <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"cmd EXIST"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果没有匹配的命令，则默认 ret 保持为 0</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>  <span class="token comment">// 返回写入响应数据的长度</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
 * 函数: kvs_protocol
 * -------------------
 * KV 存储协议的处理入口函数，用于处理客户端请求并生成响应。
 *
 * 参数:
 *   msg      - 接收到的请求消息
 *   length   - 请求消息的长度
 *   response - 用于保存响应消息的缓冲区
 *
 * 返回:
 *   响应消息的长度；如果参数非法则返回 -1。
 *
 * 说明:
 *   请求格式例如：
 *      SET Key Value
 *      GET Key
 *      DEL Key
 */</span>
<span class="token keyword">int</span> <span class="token function">kvs_protocol</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 参数检查：msg 和 response 不能为空，length 必须大于 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> length <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> response <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 打印接收到的消息和长度（调试信息）</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv %d : %s\n"</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 定义 tokens 数组，用于保存分割后的 token，数组大小由宏 KVS_MAX_TOKENS 定义</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>tokens<span class="token punctuation">[</span>KVS_MAX_TOKENS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用 kvs_split_token 对消息进行分割，返回 token 数量</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">kvs_split_token</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> tokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 可选：如果需要将请求消息原样复制到响应缓冲区，则可以使用 memcpy（当前被注释掉）</span>
    <span class="token comment">// memcpy(response, msg, length);</span>
 
    <span class="token comment">// 调用 kvs_filter_protocol 处理分割后的 token，并生成响应，返回响应长度</span>
    <span class="token keyword">return</span> <span class="token function">kvs_filter_protocol</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> count<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
 * 函数: main
 * -----------
 * 程序入口函数，启动服务器并传入 KV 协议处理函数。
 *
 * 参数:
 *   argc - 命令行参数的个数
 *   argv - 命令行参数数组，第一个参数为程序名称，第二个参数为端口号
 *
 * 返回:
 *   程序的退出状态，正常情况下返回 0，否则返回 -1。
 *
 * 说明:
 *   根据编译宏 NETWORK_SELECT 的定义，选择不同的网络模型启动服务器，
 *   如 Reactor、Proactor 或其他模型。kvs_protocol 被作为回调函数传递进去，
 *   用于处理客户端请求。
 */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 要求传入端口号作为命令行参数</span>
 
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将端口号参数转换为整数</span>
    
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NETWORK_SELECT <span class="token operator">==</span> NETWORK_REACTOR<span class="token punctuation">)</span></span></span>
    <span class="token comment">// 如果选择 Reactor 模式，调用 reactor_start，并传入端口号和 kvs_protocol 回调函数</span>
    <span class="token function">reactor_start</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> kvs_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>NETWORK_SELECT <span class="token operator">==</span> NETWORK_PROACTOR<span class="token punctuation">)</span></span></span>
    <span class="token comment">// 如果选择 Proactor 模式，调用 ntyco_start，并传入相应参数</span>
    <span class="token function">ntyco_start</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> kvs_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>NETWORK_SELECT <span class="token operator">==</span> NETWORK_NTYCO<span class="token punctuation">)</span></span></span>
    <span class="token comment">// 如果选择 NTYCO 模式，调用 proactor_start，并传入相应参数</span>
    <span class="token function">proactor_start</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> kvs_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>
</code></pre>
         <h4><a id="_587"></a>实现结果</h4>
         <p>这里的循环成功输出了分割后的tokens，证明协议实现成功，把client输入的字符通过kvs_split_token分割<br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/efb05b62257d454b8be57368d19b7d6a.png" alt="在这里插入图片描述"></p>
         <h4><a id="3_list_591"></a>3. 实现list数组用来储存数据</h4>
         <p>并加上功能：SET GET DEL MOD EXIST 等</p>
         <ul>
          <li>设置命令格式：<br> int <strong>kvs_filter_protocol</strong>(char **tokens, int count, char *response)<pre class="set-code-show"><code class="prism language-c"><span class="token number">1.</span>SET Key Value
  OK
<span class="token number">2.</span>GET Key
  Value
<span class="token number">3.</span>MOD Key Value
  OK
<span class="token number">4.</span>DEL Key
  OK
<span class="token number">5.</span>EXIST Key
  YES<span class="token operator">/</span> NO
</code></pre></li>
         </ul>
         <p>kvstore.c添加：</p>
         <pre class="set-code-show"><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kvstore.h"</span>  <span class="token comment">// 引入头文件，包含宏定义、结构体定义和函数声明</span></span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_ARRAY</span></span>
<span class="token keyword">extern</span> <span class="token class-name">kvs_array_t</span> global_array<span class="token punctuation">;</span>  <span class="token comment">// 声明全局的键值数组变量，用于存储键值对</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
<span class="token comment">// 内存分配函数封装，调用标准库的 malloc</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 内存释放函数封装，调用标准库的 free</span>
<span class="token keyword">void</span> <span class="token function">kvs_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">// 命令字符串数组，用于解析客户端的命令</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>command<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"SET"</span><span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"DEL"</span><span class="token punctuation">,</span> <span class="token string">"MOD"</span><span class="token punctuation">,</span> <span class="token string">"EXIST"</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token comment">// 枚举类型，定义每个命令对应的数值</span>
<span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
    KVS_CMD_START <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    KVS_CMD_SET <span class="token operator">=</span> KVS_CMD_START<span class="token punctuation">,</span>  <span class="token comment">// SET 命令：设置键值对</span>
    KVS_CMD_GET<span class="token punctuation">,</span>                  <span class="token comment">// GET 命令：获取指定键的值</span>
    KVS_CMD_DEL<span class="token punctuation">,</span>                  <span class="token comment">// DEL 命令：删除指定键</span>
    KVS_CMD_MOD<span class="token punctuation">,</span>                  <span class="token comment">// MOD 命令：修改指定键的值</span>
    KVS_CMD_EXIST<span class="token punctuation">,</span>                <span class="token comment">// EXIST 命令：检测键是否存在</span>
    KVS_CMD_COUNT<span class="token punctuation">,</span>                <span class="token comment">// 命令总数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token comment">// 响应字符串数组（预留扩展，目前未使用）</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>response<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 可根据需要添加响应字符串</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token comment">// 函数：kvs_split_token</span>
<span class="token comment">// 作用：将传入的消息按照空格分割成多个 token，并存入 tokens 数组中</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//    msg    - 要分割的字符串（客户端请求消息）</span>
<span class="token comment">//    tokens - 用于存储分割后各个 token 的数组</span>
<span class="token comment">// 返回值：成功时返回 token 的数量；若失败则返回 -1</span>
<span class="token keyword">int</span> <span class="token function">kvs_split_token</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>tokens<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查输入参数是否有效</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> tokens <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用 strtok 函数以空格为分隔符分割字符串</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>token <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 循环提取每个 token</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"idx: %d, %s\n"</span><span class="token punctuation">,</span> idx<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokens<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> token<span class="token punctuation">;</span>      <span class="token comment">// 保存 token 到数组中</span>
        token <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取下一个 token</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> idx<span class="token punctuation">;</span>  <span class="token comment">// 返回 token 的数量</span>
<span class="token punctuation">}</span>
 
 
<span class="token comment">// 函数：kvs_filter_protocol</span>
<span class="token comment">// 作用：根据分割后的 token 分析请求协议，并调用相应的数组操作函数</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//    tokens   - 分割后的 token 数组</span>
<span class="token comment">//    count    - token 的数量</span>
<span class="token comment">//    response - 用于存储响应消息的缓冲区</span>
<span class="token comment">// 返回值：响应消息的长度，失败时返回 -1</span>
<span class="token keyword">int</span> <span class="token function">kvs_filter_protocol</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>tokens<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 参数有效性检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> count <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> response <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
    <span class="token keyword">int</span> cmd <span class="token operator">=</span> KVS_CMD_START<span class="token punctuation">;</span>
    <span class="token comment">// 根据第一个 token 判断是哪个命令</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>cmd <span class="token operator">=</span> KVS_CMD_START<span class="token punctuation">;</span> cmd <span class="token operator">&lt;</span> KVS_CMD_COUNT<span class="token punctuation">;</span> cmd<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>tokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> command<span class="token punctuation">[</span>cmd<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 找到匹配的命令则退出循环</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
 
    <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 用于存储生成的响应消息长度</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// 操作返回值</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>key <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 第二个 token 为键</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>value <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 第三个 token 为值（针对 SET 和 MOD 命令）</span>
 
    <span class="token comment">// 根据不同的命令执行相应的操作</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> KVS_CMD_SET<span class="token operator">:</span>
            <span class="token comment">// SET 命令：将键值对存入全局数组中</span>
            ret <span class="token operator">=</span> <span class="token function">kvs_array_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>global_array<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"ERROR\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"OK\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"EXIST\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KVS_CMD_GET<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// GET 命令：根据键获取对应的值</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token function">kvs_array_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>global_array<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"NO EXIST\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"%s\r\n"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">case</span> KVS_CMD_DEL<span class="token operator">:</span>
            <span class="token comment">// DEL 命令：删除指定键</span>
            ret <span class="token operator">=</span> <span class="token function">kvs_array_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>global_array<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"ERROR\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"OK\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"NO EXIST\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KVS_CMD_MOD<span class="token operator">:</span>
            <span class="token comment">// MOD 命令：修改指定键的值</span>
            ret <span class="token operator">=</span> <span class="token function">kvs_array_mod</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>global_array<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"ERROR\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"OK\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"NO EXIST\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> KVS_CMD_EXIST<span class="token operator">:</span>
            <span class="token comment">// EXIST 命令：检测键是否存在</span>
            ret <span class="token operator">=</span> <span class="token function">kvs_array_exist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>global_array<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"EXIST\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">"NO EXIST\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> length<span class="token punctuation">;</span>  <span class="token comment">// 返回响应消息的长度</span>
<span class="token punctuation">}</span>
 
 
<span class="token comment">/*
 * 函数：kvs_protocol
 * 作用：处理客户端的请求消息，解析协议并生成响应消息
 * 参数：
 *    msg      - 客户端请求的消息
 *    length   - 请求消息的长度
 *    response - 存储生成的响应消息的缓冲区
 * 返回值：
 *    响应消息的长度，若处理失败则返回 -1
 */</span>
<span class="token keyword">int</span> <span class="token function">kvs_protocol</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查输入参数是否有效</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> length <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> response <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv %d : %s\n"</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 定义一个 token 数组，用于存储分割后的字符串，最多支持 KVS_MAX_TOKENS 个 token</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>tokens<span class="token punctuation">[</span>KVS_MAX_TOKENS<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 调用函数分割消息为 token</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token function">kvs_split_token</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> tokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 根据分割后的 token 执行协议解析和相应操作</span>
    <span class="token keyword">return</span> <span class="token function">kvs_filter_protocol</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> count<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
 
<span class="token comment">/*
 * 函数：init_kvengine
 * 作用：初始化键值存储引擎，主要包括全局数组的初始化
 * 返回值：
 *    0 表示初始化成功
 */</span>
<span class="token keyword">int</span> <span class="token function">init_kvengine</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_ARRAY</span></span>
    <span class="token comment">// 将 global_array 结构体内容置0，确保初始化干净</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>global_array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用创建函数，可能会在内部动态分配内存</span>
    <span class="token function">kvs_array_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>global_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
 
<span class="token comment">/*
 * 主函数
 * 作用：程序入口，根据命令行参数获取端口号，初始化键值引擎，并启动网络服务
 */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查命令行参数是否正确，要求传入一个端口号</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 将命令行参数（端口号字符串）转换为整数</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">// 初始化键值引擎</span>
    <span class="token function">init_kvengine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 根据预编译时选择的网络模型启动相应的服务</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>NETWORK_SELECT <span class="token operator">==</span> NETWORK_REACTOR<span class="token punctuation">)</span></span></span>
    <span class="token function">reactor_start</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> kvs_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>NETWORK_SELECT <span class="token operator">==</span> NETWORK_PROACTOR<span class="token punctuation">)</span></span></span>
    <span class="token function">ntyco_start</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> kvs_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token punctuation">(</span>NETWORK_SELECT <span class="token operator">==</span> NETWORK_NTYCO<span class="token punctuation">)</span></span></span>
    <span class="token function">proactor_start</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> kvs_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
 
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
         <h4><a id="4_kvs_arrayc_826"></a>4. 添加kvs_array.c,实现功能：</h4>
         <pre class="set-code-show"><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"kvstore.h"</span></span>
 
<span class="token comment">// 全局单例：键值数组，用于存储所有的键值对数据</span>
<span class="token class-name">kvs_array_t</span> global_array <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token comment">/*
 * 函数：kvs_array_create
 * 作用：初始化一个键值数组实例，为其分配内存空间，并设置初始状态
 * 参数：
 *      inst - 指向待初始化的 kvs_array_t 结构体实例的指针
 * 返回值：
 *      0  - 初始化成功
 *      -1 - 出现错误（例如 inst 为 NULL 或内存分配失败）
 */</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_create</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查传入的实例指针是否为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inst<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果 table 已经被分配内存，则打印提示并返回错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"table has alloc\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 为 table 分配足够的内存，大小为 KVS_ARRAY_SIZE 个 kvs_array_item_t 结构体</span>
    inst<span class="token operator">-&gt;</span>table <span class="token operator">=</span> <span class="token function">kvs_malloc</span><span class="token punctuation">(</span>KVS_ARRAY_SIZE <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_item_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 初始化数组中已有的键值对数量为 0</span>
    inst<span class="token operator">-&gt;</span>total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
 * 函数：kvs_array_destory
 * 作用：销毁键值数组实例，释放其占用的内存资源
 * 参数：
 *      inst - 指向待销毁的 kvs_array_t 结构体实例的指针
 * 注意：
 *      此处函数名存在拼写错误，正确名称应为 kvs_array_destroy
 */</span>
<span class="token keyword">void</span> <span class="token function">kvs_array_destory</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查传入的实例指针是否为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inst<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果 table 不为空，则释放 table 占用的内存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">kvs_free</span><span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
 * 函数：kvs_array_set
 * 作用：在键值数组中添加一个新的键值对
 * 参数：
 *      inst  - 指向键值数组实例的指针
 *      key   - 要添加的键（字符串）
 *      value - 要添加的值（字符串）
 * 返回值：
 *      &lt; 0 : 出现错误（例如参数错误或内存分配失败）
 *      = 0 : 添加成功
 *      &gt; 0 : 键已存在
 */</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_set</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查输入参数是否有效</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果数组已满，则无法添加新的键值对</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>total <span class="token operator">==</span> KVS_ARRAY_SIZE<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 判断该键是否已经存在，如果存在则返回 1 表示键已存在</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token function">kvs_array_get</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 为键分配内存，并复制键字符串</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>kcopy <span class="token operator">=</span> <span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kcopy <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>kcopy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strncpy</span><span class="token punctuation">(</span>kcopy<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 为值分配内存，并复制值字符串</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>kvalue <span class="token operator">=</span> <span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>kvalue <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>kvalue<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strncpy</span><span class="token punctuation">(</span>kvalue<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历已存储的键值对，查找第一个空槽（即 key 为 NULL 的位置）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> inst<span class="token operator">-&gt;</span>total<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 在找到的空槽中存入新的键值对</span>
            inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> kcopy<span class="token punctuation">;</span>
            inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> kvalue<span class="token punctuation">;</span>
            <span class="token comment">// 增加总数计数器</span>
            inst<span class="token operator">-&gt;</span>total<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果遍历结束时所有槽都已占用，但总数未达到数组上限，则在数组尾部插入新的键值对</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> inst<span class="token operator">-&gt;</span>total <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> KVS_ARRAY_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> kcopy<span class="token punctuation">;</span>
        inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> kvalue<span class="token punctuation">;</span>
        inst<span class="token operator">-&gt;</span>total<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
 * 函数：kvs_array_get
 * 作用：根据指定的键，在键值数组中查找并返回对应的值
 * 参数：
 *      inst - 指向键值数组实例的指针
 *      key  - 要查找的键（字符串）
 * 返回值：
 *      找到则返回对应的值的指针，否则返回 NULL
 */</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">kvs_array_get</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 参数检查：确保实例和键均不为 NULL</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历数组，查找匹配的键</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> inst<span class="token operator">-&gt;</span>total<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果当前槽为空，则跳过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果找到匹配的键，则返回其对应的值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果未找到匹配的键，则返回 NULL</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
 * 函数：kvs_array_del
 * 作用：删除键值数组中指定的键值对，并释放相关内存
 * 参数：
 *      inst - 指向键值数组实例的指针
 *      key  - 要删除的键（字符串）
 * 返回值：
 *      &lt; 0 : 出现错误（例如参数无效）
 *      = 0 : 删除成功
 *      &gt; 0 : 未找到指定键，返回遍历的索引值（大于0）
 */</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_del</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查输入参数是否有效</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历数组查找匹配的键</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> inst<span class="token operator">-&gt;</span>total<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果找到匹配的键</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 释放键所占内存，并将指针设为 NULL</span>
            <span class="token function">kvs_free</span><span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 释放值所占内存，并将指针设为 NULL</span>
            <span class="token function">kvs_free</span><span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 未找到匹配的键，返回最后遍历的索引值</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
 * 函数：kvs_array_mod
 * 作用：修改键值数组中已存在的键对应的值
 * 参数：
 *      inst  - 指向键值数组实例的指针
 *      key   - 要修改的键（字符串）
 *      value - 新的值（字符串）
 * 返回值：
 *      &lt; 0 : 出现错误（例如参数无效或内存分配失败）
 *      = 0 : 修改成功
 *      &gt; 0 : 指定键不存在，返回遍历时的索引值
 */</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_mod</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查输入参数是否有效</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inst <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历数组查找指定的键</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> inst<span class="token operator">-&gt;</span>total<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果当前槽为空，则跳过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 如果找到匹配的键，则进行修改</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 释放原有值的内存</span>
            <span class="token function">kvs_free</span><span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 为新值分配内存，并复制新值字符串</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>kvalue <span class="token operator">=</span> <span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>kvalue <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>kvalue<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>kvalue<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 更新当前槽中的值指针</span>
            inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> kvalue<span class="token punctuation">;</span>
            
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 如果遍历后未找到匹配的键，则返回遍历到的索引值</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/*
 * 函数：kvs_array_exist
 * 作用：检查键值数组中是否存在指定的键
 * 参数：
 *      inst - 指向键值数组实例的指针
 *      key  - 要检查的键（字符串）
 * 返回值：
 *      0 - 指定键存在
 *      1 - 指定键不存在
 */</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_exist</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 调用 kvs_array_get 查找该键对应的值</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token function">kvs_array_get</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 若返回 NULL，则表示键不存在，返回 1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 键存在则返回 0</span>
<span class="token punctuation">}</span>
</code></pre>
         <h4><a id="5_kvstoreh_1074"></a>5. kvstore.h添加定义</h4>
         <pre class="set-code-show"><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__KV_STORE_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__KV_STORE_H__</span></span>
 
<span class="token comment">// 引入标准库头文件：</span>
<span class="token comment">// stdio.h － 提供标准输入输出函数，如 printf、fprintf 等</span>
<span class="token comment">// string.h － 提供字符串处理函数，如 strcpy、strlen、strcmp 等</span>
<span class="token comment">// stdlib.h － 提供动态内存分配函数，如 malloc、free，以及其它实用函数</span>
<span class="token comment">// stddef.h － 定义常用数据类型，如 size_t</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stddef.h&gt;</span></span>
 
<span class="token comment">// 定义网络模型相关的宏，便于根据不同需求切换不同的网络处理方式</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NETWORK_REACTOR</span>     <span class="token expression"><span class="token number">0</span>   </span><span class="token comment">// 反应堆模型（Reactor Model）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NETWORK_PROACTOR</span>    <span class="token expression"><span class="token number">1</span>   </span><span class="token comment">// 主动模型（Proactor Model）</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NETWORK_NTYCO</span>       <span class="token expression"><span class="token number">2</span>   </span><span class="token comment">// Ntyco 模型（另一种网络处理方式）</span></span>
 
<span class="token comment">// 定义当前使用的网络模型，此处选择主动模型（Proactor Model）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NETWORK_SELECT</span>      <span class="token expression">NETWORK_PROACTOR</span></span>
 
<span class="token comment">// 定义最大令牌（token）数量，主要用于拆分和解析客户端发送的命令时的限制</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KVS_MAX_TOKENS</span>      <span class="token expression"><span class="token number">128</span></span></span>
 
<span class="token comment">// 定义是否启用数组存储模式，启用后将采用数组来存储键值对</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ENABLE_ARRAY</span>        <span class="token expression"><span class="token number">1</span></span></span>
 
<span class="token comment">// 定义消息处理函数指针类型</span>
<span class="token comment">// 参数说明：</span>
<span class="token comment">//    char *msg       - 指向接收到的消息字符串</span>
<span class="token comment">//    int length      - 消息的长度</span>
<span class="token comment">//    char *response  - 用于存放生成的响应消息的缓冲区</span>
<span class="token comment">// 返回值：</span>
<span class="token comment">//    int           - 通常表示响应消息的长度或状态码</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>msg_handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>msg<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 声明三个外部函数，用于启动不同网络模型的服务</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">reactor_start</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> port<span class="token punctuation">,</span> msg_handler handler<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 反应堆模型启动函数</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">proactor_start</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> port<span class="token punctuation">,</span> msg_handler handler<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 主动模型启动函数</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">ntyco_start</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> port<span class="token punctuation">,</span> msg_handler handler<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// Ntyco 模型启动函数</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">ENABLE_ARRAY  </span><span class="token comment">// 如果启用数组存储模式，则编译以下代码</span></span>
 
<span class="token comment">// 定义存储单个键值对的结构体</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">kvs_array_item_s</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>     <span class="token comment">// 键，字符串形式存储</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">;</span>   <span class="token comment">// 值，字符串形式存储</span>
<span class="token punctuation">}</span> <span class="token class-name">kvs_array_item_t</span><span class="token punctuation">;</span>
 
<span class="token comment">// 定义键值数组的最大容量</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KVS_ARRAY_SIZE</span>      <span class="token expression"><span class="token number">1024</span></span></span>
 
<span class="token comment">// 定义存储多个键值对的数组结构体</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">kvs_array_s</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">kvs_array_item_t</span> <span class="token operator">*</span>table<span class="token punctuation">;</span>  <span class="token comment">// 指向存放键值对的数组</span>
    <span class="token keyword">int</span> idx<span class="token punctuation">;</span>                  <span class="token comment">// 当前索引（可以用于其他操作，目前未详细说明具体用途）</span>
    <span class="token keyword">int</span> total<span class="token punctuation">;</span>                <span class="token comment">// 数组中已存储的键值对数量</span>
<span class="token punctuation">}</span> <span class="token class-name">kvs_array_t</span><span class="token punctuation">;</span>
 
<span class="token comment">// 声明函数：初始化键值数组实例，分配内存并设置初始状态</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//   kvs_array_t *inst - 指向待初始化的键值数组实例</span>
<span class="token comment">// 返回值：</span>
<span class="token comment">//   int - 返回 0 表示成功，否则表示错误</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_create</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 声明函数：销毁键值数组实例，释放所占用的内存资源</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//   kvs_array_t *inst - 指向待销毁的键值数组实例</span>
<span class="token comment">// 注意：函数名中存在拼写错误（destory），正确名称应为 destroy</span>
<span class="token keyword">void</span> <span class="token function">kvs_array_destory</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 声明函数：在键值数组中添加一个键值对</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//   kvs_array_t *inst - 指向键值数组实例</span>
<span class="token comment">//   char *key       - 要添加的键</span>
<span class="token comment">//   char *value     - 要添加的值</span>
<span class="token comment">// 返回值：</span>
<span class="token comment">//   int - 小于 0 表示出错，0 表示添加成功，大于 0 表示该键已存在</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_set</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 声明函数：根据指定的键从数组中查找并返回对应的值</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//   kvs_array_t *inst - 指向键值数组实例</span>
<span class="token comment">//   char *key       - 要查找的键</span>
<span class="token comment">// 返回值：</span>
<span class="token comment">//   char* - 如果找到则返回对应的值，否则返回 NULL</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">kvs_array_get</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 声明函数：删除键值数组中的指定键值对，并释放其占用的内存</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//   kvs_array_t *inst - 指向键值数组实例</span>
<span class="token comment">//   char *key       - 要删除的键</span>
<span class="token comment">// 返回值：</span>
<span class="token comment">//   int - 小于 0 表示出错，0 表示删除成功，大于 0 表示未找到该键（返回遍历的索引值）</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_del</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 声明函数：修改键值数组中已存在键对应的值</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//   kvs_array_t *inst - 指向键值数组实例</span>
<span class="token comment">//   char *key       - 要修改的键</span>
<span class="token comment">//   char *value     - 新的值</span>
<span class="token comment">// 返回值：</span>
<span class="token comment">//   int - 小于 0 表示出错，0 表示修改成功，大于 0 表示指定键不存在（返回遍历时的索引值）</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_mod</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 声明函数：检测键值数组中是否存在指定的键</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//   kvs_array_t *inst - 指向键值数组实例</span>
<span class="token comment">//   char *key       - 要检测的键</span>
<span class="token comment">// 返回值：</span>
<span class="token comment">//   int - 返回 0 表示键存在，非 0 表示键不存在</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_exist</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// ENABLE_ARRAY</span></span>
 
<span class="token comment">// 声明封装的内存分配函数，内部调用标准库的 malloc</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//   size_t size - 需要分配的内存大小（字节数）</span>
<span class="token comment">// 返回值：</span>
<span class="token comment">//   void* - 指向分配内存的指针，如果分配失败则返回 NULL</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// 声明封装的内存释放函数，内部调用标准库的 free</span>
<span class="token comment">// 参数：</span>
<span class="token comment">//   void *ptr - 指向要释放内存区域的指针</span>
<span class="token keyword">void</span> <span class="token function">kvs_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// __KV_STORE_H__</span></span>
</code></pre>
         <h4><a id="_1208"></a>编译命令</h4>
         <p>gcc -o kvstore kvstore.c ntyco.c proactor.c kvs_array.c -I ./NytCo/core/ -L ./NtyCo/ -lntyco -luring</p>
         <h4><a id="_1211"></a>测试结果</h4>
         <p>server<br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/46e99d6e592943dc850d1f0e664b3e58.png" alt="在这里插入图片描述"><br> client<br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/639ba4d67f2e466e97b21a0daf07056e.png" alt="在这里插入图片描述"></p>
         <hr>
         <h3><a id="BUG_1221"></a>BUG整理</h3>
         <p><img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/3f54d24ddc954754a89fb4aae10bf7f6.png" alt="在这里插入图片描述"></p>
         <hr>
         <h2><a id="_1225"></a>三、引擎层设计</h2>
         <h3><a id="0_KV_1226"></a>0. KV引擎层介绍</h3>
         <p>​ 使用数组、红黑树、哈希表作为底层数据存储结构来构建KV引擎。该引擎由5 + 2组成，<em>5个CRUD，2个资源管理函数</em>。目前资源的分配和释放暂时由malloc和free组成。</p>
         <p>2个资源管理函数</p>
         <pre class="set-code-show"><code class="prism language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">kvs_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
         <p>在下面主要介绍CRUD</p>
         <h3><a id="1_kvs_array_1241"></a>1. kvs_array</h3>
         <h4><a id="_1242"></a>数据结构设计</h4>
         <p>第一个结构体存放键值对，第二个结构体存放数组的额外信息。采用这种方式可以比较好地表示数组信息，在未来需要扩充功能时可以在kvs_array_t中添加。</p>
         <pre class="set-code-show"><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">kvs_array_item_s</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
	<span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">kvs_array_item_t</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">kvs_array_s</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">kvs_array_item_t</span> <span class="token operator">*</span>table<span class="token punctuation">;</span>
	<span class="token keyword">int</span> idx<span class="token punctuation">;</span>
	<span class="token keyword">int</span> total<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">kvs_array_t</span><span class="token punctuation">;</span>
</code></pre>
         <h4><a id="_1256"></a>功能函数设计</h4>
         <pre class="set-code-show"><code class="prism language-c"><span class="token comment">// 根据数组大小分配资源，数组长度暂时取1024</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_create</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 释放资源</span>
<span class="token keyword">void</span> <span class="token function">kvs_array_destory</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// </span>
<span class="token keyword">int</span> <span class="token function">kvs_array_set</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>inst <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> key <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>total <span class="token operator">==</span> KVS_ARRAY_SIZE<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>str <span class="token operator">=</span> <span class="token function">kvs_array_get</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>kcopy <span class="token operator">=</span> <span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>kcopy <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>kcopy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strncpy</span><span class="token punctuation">(</span>kcopy<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">char</span> <span class="token operator">*</span>kvalue <span class="token operator">=</span> <span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>kvalue <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>kvalue<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strncpy</span><span class="token punctuation">(</span>kvalue<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> inst<span class="token operator">-&gt;</span>total<span class="token punctuation">;</span>i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			
			inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> kcopy<span class="token punctuation">;</span>
			inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> kvalue<span class="token punctuation">;</span>
			inst<span class="token operator">-&gt;</span>total <span class="token operator">++</span><span class="token punctuation">;</span>
			
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 如果全满可直接开新的数组</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> inst<span class="token operator">-&gt;</span>total <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> KVS_ARRAY_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">=</span> kcopy<span class="token punctuation">;</span>
		inst<span class="token operator">-&gt;</span>table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> kvalue<span class="token punctuation">;</span>
		inst<span class="token operator">-&gt;</span>total <span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 遍历数组找到是否存在键值为key的</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">kvs_array_get</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 先找后删除即可</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_del</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 先找后修改</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_mod</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 调用get即可</span>
<span class="token keyword">int</span> <span class="token function">kvs_array_exist</span><span class="token punctuation">(</span><span class="token class-name">kvs_array_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
         <h3><a id="2_kvs_rbtree_1317"></a>2. kvs_rbtree</h3>
         <h4><a id="_1318"></a>数据结构设计</h4>
         <p>该数据结构基本采用红黑树的设计，对于红黑树中的增删改查操作需要稍作修改，因为我们通常是使用字符串来进行存储</p>
         <pre class="set-code-show"><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_rbtree_node</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> color<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_rbtree_node</span> <span class="token operator">*</span>right<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_rbtree_node</span> <span class="token operator">*</span>left<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">_rbtree_node</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
	KEY_TYPE key<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span> rbtree_node<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_rbtree</span> <span class="token punctuation">{<!-- --></span>
	rbtree_node <span class="token operator">*</span>root<span class="token punctuation">;</span>
	rbtree_node <span class="token operator">*</span>nil<span class="token punctuation">;</span>
<span class="token punctuation">}</span> rbtree<span class="token punctuation">;</span>
</code></pre>
         <h4><a id="_1336"></a>功能函数设计</h4>
         <pre class="set-code-show"><code class="prism language-c"><span class="token comment">// 采用红黑树存储不需要限定节点数量，当然这也意味着在每次有新节点加入时需要开辟内存</span>
<span class="token keyword">int</span> <span class="token function">kvs_rbtree_create</span><span class="token punctuation">(</span><span class="token class-name">kvs_rbtree_t</span> <span class="token operator">*</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每次找到红黑树中的最小值进行删除，时间复杂度低</span>
<span class="token keyword">void</span> <span class="token function">kvs_rbtree_destory</span><span class="token punctuation">(</span><span class="token class-name">kvs_rbtree_t</span> <span class="token operator">*</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 调用rbtree_insert</span>
<span class="token keyword">int</span> <span class="token function">kvs_rbtree_set</span><span class="token punctuation">(</span><span class="token class-name">kvs_rbtree_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inst <span class="token operator">||</span> <span class="token operator">!</span>key <span class="token operator">||</span> <span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	rbtree_node <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token punctuation">(</span>rbtree_node<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>rbtree_node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	node<span class="token operator">-&gt;</span>key <span class="token operator">=</span> <span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token operator">-&gt;</span>key<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	node<span class="token operator">-&gt;</span>value <span class="token operator">=</span> <span class="token function">kvs_malloc</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strcpy</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>value<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">rbtree_insert</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 调用rbtree_search</span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">kvs_rbtree_get</span><span class="token punctuation">(</span><span class="token class-name">kvs_rbtree_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 先搜索在删除</span>
<span class="token keyword">int</span> <span class="token function">kvs_rbtree_del</span><span class="token punctuation">(</span><span class="token class-name">kvs_rbtree_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 先所属再修改</span>
<span class="token keyword">int</span> <span class="token function">kvs_rbtree_mod</span><span class="token punctuation">(</span><span class="token class-name">kvs_rbtree_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 调用rbtree_search</span>
<span class="token keyword">int</span> <span class="token function">kvs_rbtree_exist</span><span class="token punctuation">(</span><span class="token class-name">kvs_rbtree_t</span> <span class="token operator">*</span>inst<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
         <h3><a id="3_kvs_hash_1376"></a>3. kvs_hash</h3>
         <h4><a id="_1377"></a>数据结构设计</h4>
         <p>本哈希表采用拉链法来解决哈希冲突</p>
         <pre class="set-code-show"><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">hashnode_s</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> key<span class="token punctuation">[</span>MAX_KEY_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> value<span class="token punctuation">[</span>MAX_VALUE_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">hashnode_s</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
	
<span class="token punctuation">}</span> <span class="token class-name">hashnode_t</span><span class="token punctuation">;</span>


<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">hashtable_s</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">hashnode_t</span> <span class="token operator">*</span><span class="token operator">*</span>nodes<span class="token punctuation">;</span> <span class="token comment">//* change *</span>
	<span class="token keyword">int</span> max_slots<span class="token punctuation">;</span>
	<span class="token keyword">int</span> count<span class="token punctuation">;</span>
	<span class="token class-name">pthread_mutex_t</span> lock<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">hashtable_t</span><span class="token punctuation">;</span>
</code></pre>
         <h4><a id="_1397"></a>功能函数设计</h4>
         <pre class="set-code-show"><code class="prism language-c"><span class="token comment">// 需要分配哈希表长的空间</span>
<span class="token keyword">int</span> <span class="token function">kvs_hash_create</span><span class="token punctuation">(</span><span class="token class-name">kvs_hash_t</span> <span class="token operator">*</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 逐个删除每个节点的链表</span>
<span class="token keyword">void</span> <span class="token function">kvs_hash_destory</span><span class="token punctuation">(</span><span class="token class-name">kvs_hash_t</span> <span class="token operator">*</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">kvs_hash_set</span><span class="token punctuation">(</span><span class="token class-name">kvs_hash_t</span> <span class="token operator">*</span>hash<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hash <span class="token operator">||</span> <span class="token operator">!</span>key <span class="token operator">||</span> <span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">_hash</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> MAX_TABLE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">hashnode_t</span> <span class="token operator">*</span>node <span class="token operator">=</span> hash<span class="token operator">-&gt;</span>nodes<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// 找到该节点的链表上是否已经存在key</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>node <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span>key<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// exist</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		node <span class="token operator">=</span> node<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 新建节点</span>
	<span class="token class-name">hashnode_t</span> <span class="token operator">*</span>new_node <span class="token operator">=</span> <span class="token function">_create_node</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	new_node<span class="token operator">-&gt;</span>next <span class="token operator">=</span> hash<span class="token operator">-&gt;</span>nodes<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
	hash<span class="token operator">-&gt;</span>nodes<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> new_node<span class="token punctuation">;</span>
	hash<span class="token operator">-&gt;</span>count <span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 先计算哈希值，再从链表中找</span>
<span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">kvs_hash_get</span><span class="token punctuation">(</span><span class="token class-name">kvs_hash_t</span> <span class="token operator">*</span>hash<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 先找后改</span>
<span class="token keyword">int</span> <span class="token function">kvs_hash_mod</span><span class="token punctuation">(</span><span class="token class-name">kvs_hash_t</span> <span class="token operator">*</span>hash<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 先找后删</span>
<span class="token keyword">int</span> <span class="token function">kvs_hash_del</span><span class="token punctuation">(</span><span class="token class-name">kvs_hash_t</span> <span class="token operator">*</span>hash<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 调用get</span>
<span class="token keyword">int</span> <span class="token function">kvs_hash_exist</span><span class="token punctuation">(</span><span class="token class-name">kvs_hash_t</span> <span class="token operator">*</span>hash<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
         <hr>
         <h3><a id="_1439"></a>测试用例实现</h3>
         <ul>
          <li>工程代码繁杂时，用make文件替换简化编译执行指令<br> touch Makefile 编写<br> vim Makefile （add执行代码<img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/96074a2c85cb41c99096d73509d3f785.png" alt=""><br> make clean<br> make</li>
         </ul>
         <h4><a id="testcasec_1446"></a>测试用例编写testcase.c</h4>
         <p>先确定开发模式， 再搭积木适用团队开发拓展<br> 实现功能目标：<img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/79f80c90093445ba995ebc4f69b16ca3.png" alt=""></p>
         <p><strong>服务端</strong><br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/3429588edebd4a24b169ada0977da3cf.png" alt="在这里插入图片描述"></p>
         <ul>
          <li>make clean<br> make<br> ./kvstore 2000</li>
         </ul>
         <p><strong>测试端</strong></p>
         <pre class="set-code-show"><code> + gcc -o testcase testcase.c
 + ./testcase 192.168.243.131  2000  [mode=012]
</code></pre>
         <hr>
         <h4><a id="BUG_1464"></a>BUG整理</h4>
         <p>思考array_testcase_1w， 跑9000没问题，9w就会error？<br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/6d80b2df03d54fcea14fb972a78d2f40.png" alt="在这里插入图片描述"><br> 解决:<br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/84f22048e8df4252a3019a5759e55cec.png" alt=""></p>
         <p><img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/66e9804a65584de18100e8ffae43db76.png" alt=""></p>
         <hr>
         <h2><a id="KV_1474"></a>四、KV存储性能测试</h2>
         <pre class="set-code-show"><code class="prism language-c"><span class="token number">1.</span> 网络测试tps
<span class="token number">2.</span> 吞吐量测试
<span class="token number">3.</span> go<span class="token punctuation">,</span> lua<span class="token punctuation">,</span> java多语言支持
<span class="token number">4.</span> hash<span class="token operator">/</span>list<span class="token operator">/</span>skiptable<span class="token operator">/</span>rbtree测试
</code></pre>
         <h3><a id="kvhashskiptablekvstore_1481"></a>kv引擎hash、自己实现skiptable融入kvstore</h3>
         <p><a href="https://blog.csdn.net/rayso9898/article/details/125166735">基于跳表实现的轻量级KV存储引擎</a></p>
         <p><a href="https://123wangju123.github.io/posts/%E5%AD%A6%E4%B9%A0%E9%A1%B9%E7%9B%AE-%E5%9F%BA%E4%BA%8E%E8%B7%B3%E8%A1%A8%E7%BB%93%E6%9E%84%E7%9A%84KV%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E8%AE%BE%E8%AE%A1/" rel="nofollow">「项目复现」基于跳表结构的KV存储引擎设计 | JuWang</a></p>
         <h3><a id="_1488"></a>第三方语言支持</h3>
         <p>：go, python, java, rust, nodejs<br> ​ 在kvs-client文件<br> <img src="http://toolman.ddnsfree.com:8585/cn/csdnimg/i-blog/direct/64008a4cf82a4afdac5862580f2755ca.png" alt="在这里插入图片描述"></p>
         <ol>
          <li>kvstore 你实现为什么用单线程，而不是多线程？</li><li>要实现一个范围查询，实现什么数据结构的kv引擎</li>
         </ol>
         <h3><a id="_1496"></a>十个面试题</h3>
         <pre class="set-code-show"><code class="prism language-c"><span class="token number">1.</span> 为什么会实现kvstore，使用场景在哪里？
<span class="token number">2.</span> reactor<span class="token punctuation">,</span> ntyco<span class="token punctuation">,</span> io_uring的三种网络模型的性能差异？
<span class="token number">3.</span> 多线程的kvstore该如何改进？
<span class="token number">4.</span> 私有协议如何设计会更加安全可靠？
<span class="token number">5.</span> 协议改进以后，对已有的代码有哪些改变？
<span class="token number">6.</span> kv引擎实现了哪些？
<span class="token number">7.</span> 每个kv引擎的使用场景，以及性能差异？
<span class="token number">8.</span> 测试用例如何实现？并且保证代码覆盖率超过<span class="token number">90</span><span class="token operator">%</span>
<span class="token number">9.</span> 网络并发量如何？qps如何？
<span class="token number">10.</span> 能够跟哪些系统交互使用？
</code></pre>
         <hr>
         <blockquote>
          <p>优秀笔记：<br> <a href="https://blog.csdn.net/weixin_46258766/article/details/136228729">1. 基于C语言实现内存型数据库(kv存储)</a></p>
         </blockquote></div>
        <link href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/editerView/markdown_views-375c595788.css" rel="stylesheet">
        <link href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blogv2/dist/mdeditor/css/style-e504d6a974.css" rel="stylesheet"></div>
      </article></div>
    </main></div><div class="recommend-right align-items-stretch clearfix" id="rightAside" data-type="recommend"></div></div>
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/g/lib/cboxEditor/1.1.6/embed-editor.min.css">
  <link rel="stylesheet" href="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blog_editor_html/release1.6.12/ckeditor/plugins/codesnippet/lib/highlight/styles/atom-one-dark.css">
  <script>
    $(".MathJax").remove();
    if ($('div.markdown_views pre.prettyprint code.hljs').length > 0) {
      $('div.markdown_views')[0].className = 'markdown_views';
    }
  </script>
  <script type="text/javascript" src="http://toolman.ddnsfree.com:8585/cn/csdnimg/release/blog_mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      "HTML-CSS": {
        linebreaks: { automatic: true, width: "94%container" },
        imageFont: null
      },
      tex2jax: {
      preview: "none",
      ignoreClass:"title-article"
      },
      mml2jax: {
      preview: 'none'
      }
    });
  </script>
 </body>
</html>